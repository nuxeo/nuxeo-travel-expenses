<dom-module id="nx-workflow-list">

  <link rel="import" type="css" href="nx-workflow-list.css">

  <template>
    <link rel="stylesheet" href="nx-workflow-list.css">

    <!-- The workflow instance resource -->
    <nx-resource id="workflow"></nx-resource>

    <div id="list">

      <!-- List of workflow instances -->
      <iron-list id="list" items="[[workflows]]" as="item" on-iron-select="select">
        <template>
          <paper-icon-item class="item">
            <iron-icon icon="group-work" item-icon></iron-icon>
            <span class="flex">[[i18n(item.title)]]</span>
            <div class="state">[[item.state]]</div>
            <paper-icon-button icon="delete" style="float:right" on-tap="deleteWorkflow"></paper-icon-button>
          </paper-icon-item>
        </template>
      </iron-list>
    </div>

    <paper-fab icon="add" title="Add" on-tap="{{newEntry}}"></paper-fab>

    <paper-toast id="createdMessage" text="Started workflow."></paper-toast>
    <paper-toast id="deletedMessage" text="Deleted workflow."></paper-toast>
  </template>
</dom-module>
<script>
  (function () {
    Polymer({
      is: 'nx-workflow-list',

      properties: {
        workflow: {
          notify: true,
          observer: 'workflowChanged'
        },
        workflowModel: {
          type: String,
          notify: true
        },
        workflows: { value: [] }
      },

      ready: function () {
        this.workflowChanged();
        this.updateWorkflows();
      },

      select: function (e, detail) {
        this.workflow = detail.data;
      },

      newEntry: function () {
        this.workflow = {
          'entity-type': 'workflow',
          workflowModelName: this.workflowModel
        };
        this.$.workflow.post(this.workflow)
          // get the task for the new workflow instance
          .then(function (response) {
            this.$.createdMessage.show();
            this.updateWorkflows();
        }.bind(this));
      },

      updateWorkflows: function () {
        this.workflow = null;
        this.$.workflow.get().then(function (data) {
          this.workflows = data.entries;
        }.bind(this))
          .catch(function (e) {
            console.debug(e);
          });
      },

      deleteWorkflow: function (e) {
        var doDelete = window.confirm('Are you sure you want to delete ?');
        if (doDelete) {
          this.workflow = e.model.item;
          this.$.workflow.remove().then(function () {
            this.$.deletedMessage.show();
            this.updateWorkflows();
          }.bind(this));
        }
        return false;
      },

      workflowChanged: function () {
        this.$.workflow.path = '/workflow/' + ((this.workflow) ? this.workflow.id : '');
      }
    });
  }());
</script>
