<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../../bower_components/core-field/core-field.html">
<link rel="import" href="../../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../../bower_components/core-item/core-item.html">
<link rel="import" href="../../bower_components/core-list/core-list.html">
<link rel="import" href="../../bower_components/nuxeo-elements/nx-resource.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<polymer-element name="nx-workflow-list" attributes="workflowModel" layout vertical>
  <template>
    <link rel="stylesheet" href="nx-workflow-list.css">

    <!-- The workflow instance resource -->
    <nx-resource id="workflow" path="/workflow/{{workflow.id}}"></nx-resource>


    <div id="list">
      <!-- List of workflow instances -->
      <core-list id="list" data="{{workflows}}" on-core-activate="{{select}}">
        <template>
          <core-item icon="group-work" class="item">
            <div flex>
              {{model.title | i18n}}
            </div>
            <div class="state">{{model.state}}</div>
            <core-icon-button icon="delete" style="float:right" on-tap="{{deleteWorkflow}}"></core-icon-button>
          </core-item>
        </template>
      </core-list>
    </div>

    <paper-fab icon="add" title="Add" on-tap="{{newEntry}}"></paper-fab>

    <paper-toast id="createdMessage" text="Started workflow."></paper-toast>
    <paper-toast id="deletedMessage" text="Deleted workflow."></paper-toast>
  </template>
  <script>
    (function () {
      Polymer({

        workflows: null,
        workflow: null,

        ready: function () {
          this.updateWorkflows();
        },

        select: function (e, detail) {
          this.workflow = detail.data;
        },


        newEntry: function () {
          this.workflow = {
            'entity-type': 'workflow',
            workflowModelName: this.workflowModel
          };
          this.$.workflow.post(this.workflow)
            // get the task for the new workflow instance
            .then(function (response) {
              this.$.createdMessage.show();
              this.updateWorkflows();
            }.bind(this))

        },

        updateWorkflows: function () {
          this.workflow = null;
          this.$.workflow.get().then(function (data) {
            this.workflows = data.entries;
          }.bind(this));
        },

        deleteWorkflow: function (e, detail, sender) {
          e.preventDefault();
          e.stopPropagation();
          var doDelete = window.confirm("Are you sure you want to delete ?");
          if (doDelete) {
            this.workflow = sender.templateInstance.model.model;
            this.$.workflow.remove().then(function () {
              this.$.deletedMessage.show();
              this.updateWorkflows();
            }.bind(this));
          }
          return false;
        }
      });
    })();
  </script>
</polymer-element>
